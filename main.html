<!DOCTYPE html>
<html lang="ja">

<head>
 <meta charset="UTF-8">
 <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://unpkg.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
    style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
    font-src 'self' https://cdn.jsdelivr.net;
">
 <title>チャットデコレーション! v0.3</title>
 <script src="https://unpkg.com/vue@3.4.19/dist/vue.global.prod.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.8/dist/vuetify.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/vuedraggable@4.0.2/dist/vuedraggable.umd.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.6/dist/sweetalert2.all.min.js"></script>
 <script src="./_lib/templates.js"></script>
 <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.5.8/dist/vuetify.min.css">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.6/dist/sweetalert2.min.css">
</head>


<body>
 <div id="app">
  <v-app :theme="DATAOBJ.preferences.theme">

   <!-- 左部ナビゲーション -->
   <v-navigation-drawer color="primary" expand-on-hover rail permanent>
    <v-list>
     <v-list-item prepend-avatar="./img/boy01_cap01.gif" title="チャッデコ!"></v-list-item>
     <v-divider></v-divider>
     <v-list-subheader>#deco</v-list-subheader>
     <v-list-item prepend-icon="mdi-pound" title="#ベーシック" subtitle="#deco で付与するスタイル"
      @click="tab = 'BASIC_deco',tmp_updata()"></v-list-item>
     <v-list-item prepend-icon="mdi-certificate" title="ロール" subtitle="役職専用の#deco"
      @click="tab = 'ROLE_deco',tmp_updata()"></v-list-item>
     <v-list-item prepend-icon="mdi-account" title="ユーザー" subtitle="ユーザー専用の#deco"
      @click="tab = 'USER_deco',tmp_updata()"></v-list-item>

     <v-divider></v-divider>
     <v-list-subheader>カラーデータ</v-list-subheader>
     <v-list-item prepend-icon="mdi-palette" title="テキスト色" subtitle="テキスト色を変更する"
      @click="tab = 'TEXTCOLOR'"></v-list-item>
     <v-list-item prepend-icon="mdi-image" title="背景色" subtitle="背景色を変更する" @click="tab = 'BACKCOLOR'"></v-list-item>
     <v-list-item prepend-icon="mdi-texture" title="グラデーション" subtitle="グラデーション設定"
      @click="tab = 'GRADATION'"></v-list-item>
     <v-list-item prepend-icon="mdi-unicorn" title="背景画像" subtitle="画像を変更する" @click="tab = 'IMAGES'"></v-list-item>
     <v-divider></v-divider>
     <v-list-subheader>設定</v-list-subheader>
     <v-list-item prepend-icon="mdi-cog" title="基本設定" subtitle="機能のON/OFFなど"
      @click="tab = 'preferences',tmp_updata()"></v-list-item>


   </v-navigation-drawer>


   <v-main>
    <!-- タイトルバー -->
    <v-row>
     <v-col cols="12" sm="6">
      <v-img max-height="120" :src="Onecometemplate[OnecomeSelect].img"></v-img>
     </v-col>
     <v-col cols="12" sm="6">
      <v-container class="d-flex align-end flex-column">
       <v-row>
        <!-- わんコメテンプレ選択 -->
        <v-col cols="4" sm="auto">
         <input type="file" accept=".json" ref="fileInput" style="display: none" @change="jsonOpenChange">
         <v-btn variant="elevated" @click="$refs.fileInput.click()">
          <v-icon>mdi-file-document</v-icon>
          読み込む
         </v-btn>
        </v-col>
        <!-- わんコメテンプレ選択 -->
        <v-col cols="4" sm="auto">
         <v-menu>
          <template v-slot:activator="{ props }">
           <v-btn v-bind="props">▼ {{ OnecomeSelect }}</v-btn>
          </template>
          <v-list>
           <v-list-item v-for="(item, index) in Onecometemplate" :key="index" @click="OnecomeSelect = index">
            <v-list-item-title>{{ item.name }}</v-list-item-title>
           </v-list-item>
          </v-list>
         </v-menu>
        </v-col>
        <!-- テンプレートを生成するボタン -->
        <v-col cols="4" sm="auto">
         <v-btn variant="elevated" color="primary" @click="outputTemplate">
          <v-icon>mdi-content-save</v-icon>
          生成
         </v-btn>
        </v-col>
       </v-row>
      </v-container>

      <!-- テーマchangeラジオボタン   -->
      <v-row>
       <!-- グリッドchangeラジオボタン   -->
       <v-col cols="7">
        <v-radio-group inline v-model="selectgridcols">
         <template v-for="pattern in Object.keys(gridcols)">
          <v-radio :key="pattern" v-model="selectgridcols" :value="pattern" hide-details>
           <v-icon>{{ gridcols[pattern].icon }}</v-icon>
          </v-radio>
          <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
         </template>
        </v-radio-group>
       </v-col>
       <!-- テーマchangeラジオボタン   -->
       <v-col cols="5">
        <v-radio-group inline v-model="DATAOBJ.preferences.theme">
         <v-radio value="light">
          <v-icon>mdi-white-balance-sunny</v-icon>
         </v-radio>
         <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
         <v-radio value="dark">
          <v-icon>mdi-moon-waning-crescent</v-icon>
         </v-radio>
        </v-radio-group>
       </v-col>
      </v-row>
     </v-col>
    </v-row>


    <!-- 1-1.BASIC_deco -->
    <v-container v-if="tab === 'BASIC_deco'">

     <!-- タイトル+空のデータ追加ボタン -->
     <d_titlebar title="#ベーシック" @addbtn="NullAddImage('BASIC_IMAGES')"></d_titlebar>

     <!-- BASIC_deco リスト表示 -->
     <draggable v-model="DATAOBJ.BASIC_IMAGES" tag="v-row" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm" :md="gridcols[selectgridcols].md"
        :lg="gridcols[selectgridcols].lg">

        <v-card :height="gridcols[selectgridcols].height" :style="getDecorationStyle(element)"
         @click="dialog[index] = true">
         <v-toolbar density="compact" color="transparent">
          <v-toolbar-title class="text-h5"># {{index+1}}</v-toolbar-title>
          <template v-slot:append>
           <v-btn height="30" width="30" icon @click.stop="clearImageArr('BASIC_IMAGES', element,index)">
            <v-icon>mdi-close</v-icon>
            <v-tooltip activator="parent" location="bottom">この設定を消去</v-tooltip>
           </v-btn>
          </template>
         </v-toolbar>

         <div style="position: absolute; bottom: 5px; left: 5px;">出現確率 : {{element.ran}}
          ({{sumRanValues(element.ran)}}%)
         </div>
        </v-card>
       </v-col>
      </template>
     </draggable>

     <!-- カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="800" v-for="(value, index) in DATAOBJ.BASIC_IMAGES" :key="index">
      <v-card height="450">
       <v-toolbar density="compact" :style="getDecorationStyle(value,4)">
        <v-toolbar-title># {{index+1}}</v-toolbar-title>
       </v-toolbar>

       <v-card-text>
        <!-- ran -->
        <v-row>
         <v-col cols="3" sm="2">
          <v-text-field type="number" v-model="value.ran" label="Weight" min="0" max="100">
           <v-tooltip activator="parent" location="bottom">ランダムに偏りをつける</v-tooltip>
          </v-text-field>
         </v-col>
         <v-col align-self="center">
          <v-progress-linear :model-value="sumRanValues(value.ran)" buffer-value="10" color="primary" height="35"
           striped>出現割合：{{sumRanValues(value.ran)}}
           %</v-progress-linear>
         </v-col>
        </v-row>

        <!-- 完成画像の表示 -->
        <bannercard :bannerstyle="getDecorationStyle(value)"></bannercard>

        <!-- COLOR -->
        <v-row>

         <!-- テキスト色 -->
         <d_textcolor :colors="DATAOBJ.TEXTCOLOR" :target="value.text"
          @selected="handleCOLOR('BASIC_IMAGES',index,'text',$event)">
         </d_textcolor>

         <!-- 背景色 -->
         <d_backcolor :colors="DATAOBJ.BACKCOLOR" :target="value.back" :btnstyle="getDecorationStyle(value, 4)"
          :liststyle="DATAOBJ.TEXTCOLOR[value.text].color"
          @selected="handleCOLOR('BASIC_IMAGES',index, 'back', $event)">
         </d_backcolor>

         <!-- グラデーション -->
         <d_gradation :colors="DATAOBJ.GRADATION" :target="value.gradation" :btnstyle="getDecorationStyle(value, 1)"
          @selected="handleCOLOR('BASIC_IMAGES',index, 'gradation', $event)">
         </d_gradation>

         <!-- キャラクター -->
         <d_images :colors="DATAOBJ.IMAGES" :target="value.img" :btnstyle="getDecorationStyle(value,2)"
          @selected="handleCOLOR('BASIC_IMAGES',index, 'img', $event)">
         </d_images>

        </v-row>
       </v-card-text>
      </v-card>
     </v-dialog>

    </v-container>


    <!-- 1-2.ROLE_deco -->
    <v-container v-if="tab === 'ROLE_deco'">

     <!-- タイトル -->

     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">ロール(誰でも/メンバー/モデレーター/配信者)</v-toolbar-title>
     </v-toolbar>
     <br>

     <!-- ROLE_deco:リスト表示 -->
     <v-row>
      <v-col v-for="(value, index) in DATAOBJ.ROLE_IMAGES" :key="value" :cols="gridcols[selectgridcols].cols"
       :sm="gridcols[selectgridcols].sm" :md="gridcols[selectgridcols].md" :lg="gridcols[selectgridcols].lg">
       <v-card :height="gridcols[selectgridcols].height"
        :style="{ ...getDecorationStyle(value), filter: !value.switch ? 'grayscale(1)' : 'none' }"
        @click="dialog[index] = true">

        <v-toolbar density="compact" color="transparent">
         <v-toolbar-title class="text-h5">{{value.name}}<span class="text-h6"
           v-if="!value.switch">(OFF)</span></v-toolbar-title>
         <template v-slot:append>
          <v-switch v-model="value.switch" color="primary" hide-details @click.stop="">
          </v-switch>
          <v-tooltip activator="parent" location="bottom">この設定をON/OFF</v-tooltip>
         </template>
        </v-toolbar>

       </v-card>
      </v-col>
     </v-row>

     <!-- ROLE_deco:カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="800" v-for="(value, index) in DATAOBJ.ROLE_IMAGES" :key="index">
      <v-card height="450">

       <v-toolbar density="compact" :style="getDecorationStyle(value,4)">
        <v-toolbar-title>{{value.name}}<span v-if="!value.switch"> (OFF)</span></v-toolbar-title>
        <template v-slot:append>
         <v-switch v-model="value.switch" color="primary" hide-details @click.stop="">
         </v-switch>
         <v-tooltip activator="parent" location="bottom">この設定をON/OFF</v-tooltip>
        </template>
       </v-toolbar>

       <!-- value.switchがOFFなら、設定不可にする -->
       <v-card-text v-if="!value.switch">
        <div class="text-center">
         この設定はOFFだよ。設定を変更するには、右上のスイッチをONにしてね。
        </div>
       </v-card-text>

       <v-card-text v-if="value.switch">
        <!-- 完成画像の表示 -->
        <bannercard :bannerstyle="getDecorationStyle(value)"></bannercard>

        <!-- COLOR -->
        <v-row>
         <!-- テキスト色 -->
         <d_textcolor :colors="DATAOBJ.TEXTCOLOR" :target="value.text"
          @selected="handleCOLOR('ROLE_IMAGES',index,'text',$event)">
         </d_textcolor>

         <!-- 背景色 -->
         <d_backcolor :colors="DATAOBJ.BACKCOLOR" :target="value.back" :btnstyle="getDecorationStyle(value, 4)"
          :liststyle="DATAOBJ.TEXTCOLOR[value.text].color" @selected="handleCOLOR('ROLE_IMAGES',index, 'back', $event)">
         </d_backcolor>

         <!-- グラデーション -->
         <d_gradation :colors="DATAOBJ.GRADATION" :target="value.gradation" :btnstyle="getDecorationStyle(value, 1)"
          @selected="handleCOLOR('ROLE_IMAGES',index, 'gradation', $event)">
         </d_gradation>

         <!-- キャラクター -->
         <d_images :colors="DATAOBJ.IMAGES" :target="value.img" :btnstyle="getDecorationStyle(value,2)"
          @selected="handleCOLOR('ROLE_IMAGES',index, 'img', $event)">
         </d_images>

        </v-row>
       </v-card-text>
      </v-card>
     </v-dialog>

    </v-container>


    <!-- 1-3.USER_deco -->
    <v-container v-if="tab === 'USER_deco'">

     <!-- タイトル+空のデータ追加ボタン -->
     <d_titlebar title="ユーザー" @addbtn="NullAddImage('USER_IMAGES')"></d_titlebar>

     <!-- USER_deco:リスト表示 -->
     <draggable v-model="DATAOBJ.USER_IMAGES" tag="v-row" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm" :md="gridcols[selectgridcols].md"
        :lg="gridcols[selectgridcols].lg">
        <v-card :height="gridcols[selectgridcols].height" :style="getDecorationStyle(element)"
         @click="dialog[index] = true">
         <v-toolbar density="compact" color="transparent">
          <v-toolbar-title>
           <div :class="element.username.join('').length >= 30 ? 'text-small' : 'text-h6'">
            <span v-for="(user, ind) in element.username" :key="ind">
             {{ user }}
             <span v-if="ind < element.username.length - 1 && user.length !== 0">, </span>
            </span>
           </div>
          </v-toolbar-title>
          <template v-slot:append>
           <v-btn height="30" width="30" icon @click.stop="clearImageArr('USER_IMAGES',element, index)">
            <v-icon>mdi-close</v-icon>
            <v-tooltip activator="parent" location="bottom">この設定を消去</v-tooltip>
           </v-btn>
          </template>
         </v-toolbar>
        </v-card>
       </v-col>
      </template>
     </draggable>

     <!-- カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="800" v-for="(value, index) in DATAOBJ.USER_IMAGES" :key="index">
      <v-card height="450">
       <v-card-title :style="getDecorationStyle(value,4)">
        <span v-for="(user, ind) in value.username" :key="ind">
         {{ user }}
         <span v-if="ind < value.username.length - 1 && user.length !== 0">, </span>
        </span>
       </v-card-title>
       <v-card-text>
        <!-- username -->
        <v-row>
         <v-col class="d-flex" v-for="(user, index) in value.username" :key="index" cols="12" sm="6" md="4"
          style="height: 50px;">
          <v-text-field density="compact" v-model="value.username[index]"></v-text-field>
          <v-btn v-if="value.username.length > 1" height="30" width="30" icon @click="value.username.splice(index, 1)"
           style="align-self: center;">
           <v-icon>mdi-close</v-icon>
          </v-btn>
         </v-col>
         <v-col class="d-flex" cols="12" sm="6" md="4">
          <v-btn v-if="value.username.length < 10" block @click="value.username.push('')">追加</v-btn>
         </v-col>
        </v-row>

        <!-- 完成画像の表示 -->
        <bannercard :bannerstyle="getDecorationStyle(value)"></bannercard>

        <!-- COLOR -->
        <v-row>
         <!-- テキスト色 -->
         <d_textcolor :colors="DATAOBJ.TEXTCOLOR" :target="value.text"
          @selected="handleCOLOR('USER_IMAGES',index,'text',$event)">
         </d_textcolor>

         <!-- 背景色 -->
         <d_backcolor :colors="DATAOBJ.BACKCOLOR" :target="value.back" :btnstyle="getDecorationStyle(value, 4)"
          :liststyle="DATAOBJ.TEXTCOLOR[value.text].color" @selected="handleCOLOR('USER_IMAGES',index, 'back', $event)">
         </d_backcolor>

         <!-- グラデーション -->
         <d_gradation :colors="DATAOBJ.GRADATION" :target="value.gradation" :btnstyle="getDecorationStyle(value, 1)"
          @selected="handleCOLOR('USER_IMAGES',index, 'gradation', $event)">
         </d_gradation>

         <!-- キャラクター -->
         <d_images :colors="DATAOBJ.IMAGES" :target="value.img" :btnstyle="getDecorationStyle(value,2)"
          @selected="handleCOLOR('USER_IMAGES',index, 'img', $event)">
         </d_images>

        </v-row>
       </v-card-text>
      </v-card>
     </v-dialog>

    </v-container>


    <!-- 2-1.TEXTCOLOR -->
    <v-container v-if="tab === 'TEXTCOLOR'">

     <!-- TEXTCOLOR:テキスト色タイトルバー -->
     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">テキスト色</v-toolbar-title>

      <v-menu>
       <template v-slot:activator="{ props }">
        <v-btn variant="elevated" v-bind="props" color="primary">
         <v-icon>mdi-plus</v-icon> 追加
         <v-tooltip activator="parent" location="bottom">テキスト色テンプレートを追加します</v-tooltip>
        </v-btn>
       </template>
       <v-list>
        <v-list-item v-for="(value, key) in TEMPLATEOBJ.TEXTCOLOR" v-on:click="SelectNewImage('TEXTCOLOR',value,key)"
         v-show="value.key !== 'none'">
         <v-list-item-title>{{value.name}}</v-list-item-title>
        </v-list-item>
       </v-list>
      </v-menu>

     </v-toolbar>
     <br>

     <!-- TEXTCOLOR:リスト -->
     <draggable v-model="tmp.TEXTCOLOR" tag="v-row" @end="tmp2STYLE('TEXTCOLOR')" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col v-show="element.key !== 'none'" :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm"
        :md="gridcols[selectgridcols].md" :lg="gridcols[selectgridcols].lg">
        <v-card variant="outlined" :height="gridcols[selectgridcols].height" @click="dialog[index] = true">
         <d_list_toolbar :element="element" @clearbtn="clearImageArr('TEXTCOLOR', element,index)"></d_list_toolbar>
         <div class="text-h3" :style="{color:element.color,position: 'absolute', bottom: '5px', right: '5px'}">
          <v-icon>mdi-pencil</v-icon>
         </div>
        </v-card>
       </v-col>
      </template>
     </draggable>


     <!-- TEXTCOLOR:カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="600" v-for="(value, index) in tmp.TEXTCOLOR" :key="index"
      @end="tmp2STYLE('TEXTCOLOR')">
      <v-card height="550">
       <v-card-title>
        {{value.name}}
        <d_dialog_name :value="value" @submit="value.name = $event"></d_dialog_name>
        <v-card-text>
         <v-row>
          <v-col cols="12" sm="5">
           <bannercard :bannerstyle="{ color: value.color}"></bannercard>
          </v-col>
          <v-col cols="12" sm="7">
           <v-color-picker v-model="value.color" swatches-max-height="120px" show-swatches></v-color-picker>
          </v-col>
         </v-row>
      </v-card>
     </v-dialog>

    </v-container>


    <!-- 2-2.BACKCOLOR -->
    <v-container v-if="tab === 'BACKCOLOR'">

     <!-- BACKCOLOR:タイトルバー -->
     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">背景色</v-toolbar-title>

      <v-menu>
       <template v-slot:activator="{ props }">
        <v-btn variant="elevated" v-bind="props" color="primary">
         <v-icon>mdi-plus</v-icon> 追加
         <v-tooltip activator="parent" location="bottom">背景色テンプレートを追加します</v-tooltip>
        </v-btn>
       </template>
       <v-list>
        <v-list-item v-for="(value, key) in TEMPLATEOBJ.BACKCOLOR" v-on:click="SelectNewImage('BACKCOLOR',value,key)"
         :style="{ backgroundColor: value.color }" v-show="value.key !== 'none'">
         <v-list-item-title>{{value.name}}</v-list-item-title>
        </v-list-item>
       </v-list>
      </v-menu>

     </v-toolbar>
     <br>

     <!-- BACKCOLOR:リスト -->
     <draggable v-model="tmp.BACKCOLOR" tag="v-row" @end="tmp2STYLE('BACKCOLOR')" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col v-show="element.key !== 'none'" :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm"
        :md="gridcols[selectgridcols].md" :lg="gridcols[selectgridcols].lg">
        <v-card variant="outlined" :height="gridcols[selectgridcols].height" :style="{ backgroundColor: element.color }"
         @click="dialog[index] = true">
         <d_list_toolbar :element="element" @clearbtn="clearImageArr('BACKCOLOR', element,index)"></d_list_toolbar>

        </v-card>
       </v-col>
      </template>
     </draggable>


     <!-- BACKCOLOR:カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="600" v-for="(value, index) in tmp.BACKCOLOR" :key="index"
      @end="tmp2STYLE('BACKCOLOR')">
      <v-card height="550">
       <v-card-title>
        {{value.name}}
        <d_dialog_name :value="value" @submit="value.name = $event"></d_dialog_name>
        <v-card-text>
         <v-row>
          <v-col cols="12" sm="5">
           <bannercard :bannerstyle="{ backgroundColor: value.color}"></bannercard>
          </v-col>
          <v-col cols="12" sm="7">
           <v-color-picker v-model="value.color" swatches-max-height="120px" show-swatches></v-color-picker>
          </v-col>
         </v-row>
      </v-card>
     </v-dialog>

    </v-container>

    <!-- 2-3.GRADATION -->
    <v-container v-if="tab === 'GRADATION'">

     <!-- GRADATION:タイトルバー -->
     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">グラデーション</v-toolbar-title>

      <v-menu>
       <template v-slot:activator="{ props }">
        <v-btn variant="elevated" v-bind="props" color="primary">
         <v-icon>mdi-plus</v-icon> 追加
         <v-tooltip activator="parent" location="bottom">グラデーションテンプレートを追加します</v-tooltip>
        </v-btn>
       </template>
       <v-list>
        <v-list-item v-for="(value, key) in TEMPLATEOBJ.GRADATION" v-on:click="SelectNewImage('GRADATION',value,key)"
         :style="getBackgroundStyle(TEMPLATEOBJ.GRADATION[key],'GRADATION')" v-show="value.key !== 'none'">
         <v-list-item-title>{{value.name}}</v-list-item-title>
        </v-list-item>
       </v-list>
      </v-menu>

     </v-toolbar>
     <br>

     <!-- GRADATION:リスト -->
     <draggable v-model="tmp.GRADATION" tag="v-row" @end="tmp2STYLE('GRADATION')" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col v-show="element.key !== 'none'" :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm"
        :md="gridcols[selectgridcols].md" :lg="gridcols[selectgridcols].lg">
        <v-card variant="outlined" :height="gridcols[selectgridcols].height"
         :style="getBackgroundStyle(element,'GRADATION')" @click="dialog[index] = true">
         <d_list_toolbar :element="element" @clearbtn="clearImageArr('GRADATION',element, index)"></d_list_toolbar>

        </v-card>
       </v-col>
      </template>
     </draggable>

     <!-- GRADATION:カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="600" v-for="(value, index) in tmp.GRADATION" :key="index"
      @end="tmp2STYLE('GRADATION')">
      <v-card height="550">
       <v-card-title>
        {{value.name}}
        <d_dialog_name :value="value" @submit="value.name = $event"></d_dialog_name>
        <v-card-text>
         <v-row>
          <v-col cols="12" sm="5">
           <bannercard :bannerstyle="getBackgroundStyle(value,'GRADATION')">
           </bannercard>
          </v-col>
          <v-col cols="12" sm="7">
           <v-textarea rows="16" v-model="value.color" label="グラデーション"></v-textarea>
          </v-col>
         </v-row>
      </v-card>
     </v-dialog>

    </v-container>

    <!-- 2-4.IMAGES -->
    <v-container v-if="tab === 'IMAGES'">

     <!-- IMAGES:タイトルバー -->
     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">背景画像</v-toolbar-title>

      <v-menu>
       <template v-slot:activator="{ props }">
        <v-btn variant="elevated" v-bind="props" color="primary">
         <v-icon>mdi-plus</v-icon> 追加
         <v-tooltip activator="parent" location="bottom">背景画像テンプレートを追加します</v-tooltip>
        </v-btn>
       </template>
       <v-list>
        <v-list-item v-for="(value, key) in TEMPLATEOBJ.IMAGES" v-on:click="SelectNewImage('IMAGES',value,key)"
         :style="getBackgroundStyle(TEMPLATEOBJ.IMAGES[key],'IMAGES')" v-show="value.key !== 'none'">
         <v-list-item-title>{{value.name}}</v-list-item-title>
        </v-list-item>
       </v-list>
      </v-menu>

     </v-toolbar>
     <br>

     <!-- IMAGES:リスト -->
     <draggable v-model="tmp.IMAGES" tag="v-row" @end="tmp2STYLE('IMAGES')" :item-key="(item, index) => index">
      <template #item="{ element, index }">
       <v-col v-show="element.key !== 'none'" :cols="gridcols[selectgridcols].cols" :sm="gridcols[selectgridcols].sm"
        :md="gridcols[selectgridcols].md" :lg="gridcols[selectgridcols].lg">
        <v-card variant="outlined" :height="gridcols[selectgridcols].height"
         :style="getBackgroundStyle(element,'IMAGES')" @click="dialog[index] = true">
         <d_list_toolbar :element="element" @clearbtn="clearImageArr('IMAGES', element,index)"></d_list_toolbar>

        </v-card>
       </v-col>
      </template>
     </draggable>

     <!-- IMAGES:カードごとのダイアログ(詳細) -->
     <v-dialog v-model="dialog[index]" max-width="600" v-for="(value, index) in tmp.IMAGES" :key="index"
      @end="tmp2STYLE('IMAGES')">
      <v-card height="550">
       <v-card-title>
        {{value.name}}
        <d_dialog_name :value="value" @submit="value.name = $event"></d_dialog_name>
        <v-card-text>
         <v-row>
          <v-col cols="12" sm="5">
           <span style="position: fixed;">
            <bannercard :bannerstyle="getBackgroundStyle(value,'IMAGES')">
            </bannercard>
           </span>
          </v-col>
          <v-col cols="12" sm="7">
           <v-file-input style="min-height: 100px" :label="`ドラッグ&ドロップで追加 : ${value.color ? value.color : ''}`"
            accept="image/*" @change="getRelative($event,'IMAGES',index)"></v-file-input>

           <div class="text-caption">背景画像の横位置</div>
           <v-slider v-model="value.positionX" step="1" min="0" max="100" class="align-center">
            <template v-slot:append>
             <v-text-field type="number" v-model="value.positionX" density="compact" min="-100" max="200"
              style="width: 80px"></v-text-field>
            </template>
           </v-slider>

           <div class="text-caption">背景画像の縦位置</div>
           <v-slider v-model="value.positionY" step="1" min="0" max="100" class="align-center">
            <template v-slot:append>
             <v-text-field type="number" v-model="value.positionY" density="compact" min="-100" max="200"
              style="width: 80px"></v-text-field>
            </template>
           </v-slider>

           <div class="text-caption">画像の並べ方</div>
           <v-select v-model="value.repeat" :items="repeatOptions" density="compact"></v-select>

           <div class="text-caption d-flex align-center">
            背景画像の大きさ(横)
            <v-checkbox v-model="value.sizeXauto" label="AUTO"></v-checkbox>
           </div>
           <v-slider v-model="value.sizeX" step="5" min="5" max="200" class="align-center" :disabled="value.sizeXauto">
            <template v-slot:append>
             <v-text-field type="number" v-model="value.sizeX" density="compact" min="5" max="300"
              style="width: 80px"></v-text-field>
            </template>
           </v-slider>

           <div class="text-caption d-flex align-center">
            背景画像の大きさ(縦)
            <v-checkbox v-model="value.sizeYauto" label="AUTO"></v-checkbox>
           </div>
           <v-slider v-model="value.sizeY" step="5" min="5" max="200" class="align-center" :disabled="value.sizeYauto">
            <template v-slot:append>
             <v-text-field type="number" v-model="value.sizeY" density="compact" min="5" max="300"
              style="width: 80px"></v-text-field>
            </template>
           </v-slider>






          </v-col>
         </v-row>
      </v-card>
     </v-dialog>

    </v-container>


    <!-- 3-1.preferences -->
    <v-container v-if="tab === 'preferences'">

     <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">基本設定</v-toolbar-title>
     </v-toolbar>
     <br>

     <v-row align="start">
      <!-- #decoできる権限 -->
      <v-col cols="12">
       <v-card variant="outlined" class="mx-auto" max-width="600">
        <v-card-item>
         <v-card-title>#decoできる権限</v-card-title>
         <v-card-subtitle>#deco、または#1 等でデコできるユーザー</v-card-subtitle>
        </v-card-item>
        <v-card-text>
         <v-radio-group inline v-model="DATAOBJ.preferences.Userlevel">
          <v-radio label="だれでも" value=0 color="amber"></v-radio>
          <v-radio label="メンバー" value=1 color="green"></v-radio>
          <v-radio label="モデレーター" value=2 color="indigo"></v-radio>
          <v-radio label="配信者" value=3 color="purple"></v-radio>
          <v-radio label="機能OFF" value=4></v-radio>
         </v-radio-group>
        </v-card-text>
       </v-card>
      </v-col>

      <!-- 自動でデコを付与する -->
      <v-col cols="12">
       <v-card variant="outlined" class="mx-auto" max-width="600">
        <v-card-item>
         <v-card-title>自動でデコを付与する</v-card-title>
         <v-card-subtitle>コメントした時点で自動的にデコが付きます</v-card-subtitle>
        </v-card-item>
        <v-card-text>
         <v-radio-group inline v-model="DATAOBJ.preferences.defaultALLdeco">
          <v-radio label="OFF" value=0></v-radio>
          <v-radio label="ON" value=1 color="red"></v-radio>
          <v-radio label="毎回ランダムにする" value=2
           :style="{ color: DATAOBJ.preferences.defaultALLdeco == 2 ? `rgb(${Array.from({ length: 3 }, () => Math.floor(Math.random() * 256)).join(', ')})` : ''}"></v-radio>
         </v-radio-group>
        </v-card-text>
       </v-card>
      </v-col>

      <!-- アナウンスを有効にする -->
      <v-col cols="12">
       <v-card variant="outlined" class="mx-auto" max-width="600">
        <v-card-item>
         <v-card-title>アナウンスを有効にする</v-card-title>
         <v-card-subtitle>#decoが付与されたときにBOTがアナウンスするか</v-card-subtitle>
        </v-card-item>
        <v-card-text>
         <v-radio-group inline v-model="DATAOBJ.preferences.enableAnnounce">
          <v-radio label="OFF" value=0></v-radio>
          <v-radio label="最初のアナウンスのみ" value=1></v-radio>
          <v-radio label="ON" value=2></v-radio>
         </v-radio-group>
        </v-card-text>
       </v-card>
       <br>
      </v-col>
      <v-divider></v-divider>
      <br>

      <!-- 設定リセット -->
      <v-col cols="12">
       <v-card class="mx-auto" max-width="600">
        <v-card-item>
         <v-card-title>設定リセット</v-card-title>
         <v-card-subtitle>デフォルトのデータに戻す</v-card-subtitle>
        </v-card-item>
        <v-card-text>
         <v-btn variant="elevated" color="error" @click="ResetDATAOBJ">
          <v-icon>mdi-alert-circle-outline</v-icon> 設定をリセットする
          <v-tooltip activator="parent" location="bottom">すべての設定を消去し、プリセットデータを読み込みます</v-tooltip>
         </v-btn>
        </v-card-text>
       </v-card>
      </v-col>

     </v-row>
    </v-container>


   </v-main>

   <!-- スナックバー表示 -->
   <v-snackbar v-model="snackbar.clear" :timeout="2000">削除したよ。</v-snackbar>
   <v-snackbar v-model="snackbar.new" :timeout="2000">新しく追加したよ。</v-snackbar>
  </v-app>
 </div>


 <script>
  // ライブラリの使用
  const draggable = window['vuedraggable'];
  const vuetify = Vuetify.createVuetify({
   // テーマ：theme: { defaultTheme: 'light' }
  });
  const app = Vue.createApp({
   data: () => ({
    tab: 'BASIC_deco', // ナビゲーション BASIC_deco
    selectgridcols: "pattern2", // アイテムの並べ方
    gridcols: {
     pattern1: { name: "pattern1", cols: 12, sm: 12, md: 12, lg: 6, height: 50, icon: "mdi-view-list" },
     pattern2: { name: "pattern2", cols: 12, sm: 6, md: 4, lg: 3, height: 100, icon: "mdi-view-grid" },
     pattern3: { name: "pattern3", cols: 4, sm: 3, md: 2, lg: 1, height: 100, icon: "mdi-view-module" },
    },
    snackbar: { copy: false, clear: false, new: false, }, // スナックバー
    dialog: Array(99).fill(false), // ダイアログ
    repeatOptions: ['repeat', 'no-repeat', 'repeat-x', 'repeat-y'], // 背景画像の選択肢

    // わんコメテンプレート
    OnecomeSelect: "json",
    Onecometemplate: {
     "json": { "name": "(jsonのみ)", "img": "./_lib/basic_deco/thumb.png" },
     "basic": { "name": "basic", "img": "./_lib/basic_deco/thumb.png" },
     "cool-pop": { "name": "cool-pop", "img": "./_lib/cool-pop_deco/thumb.png" },
     "diagonal-right": { "name": "diagonal-right", "img": "./_lib/diagonal-right_deco/thumb.png" },
     "diagonal": { "name": "diagonal", "img": "./_lib/diagonal_deco/thumb.png" },
     "retro": { "name": "retro", "img": "./_lib/retro_deco/thumb.png" },
     "slim": { "name": "slim", "img": "./_lib/slim_deco/thumb.png" }
    },

    // 各テンプレート
    TEMPLATEOBJ: {
     TEXTCOLOR: ELDERTEMPLATE.TEXTCOLOR,
     BACKCOLOR: ELDERTEMPLATE.BACKCOLOR,
     GRADATION: ELDERTEMPLATE.GRADATION,
     IMAGES: ELDERTEMPLATE.IMAGES,
    },

    // __user__.jsに記入する内容
    DATAOBJ: {
     preferences: {
      "theme": "light",
      "Userlevel": "0",
      "defaultALLdeco": "0",
      "enableAnnounce": "1"
     },
     BASIC_IMAGES: [],
     ROLE_IMAGES: {},
     USER_IMAGES: [],
     TEXTCOLOR: {},
     BACKCOLOR: {},
     GRADATION: {},
     IMAGES: {},
    },
    tmp: {
     TEXTCOLOR: [],
     BACKCOLOR: [],
     GRADATION: [],
     IMAGES: [],
    },
   }),

   components: {
    // draggable用
    draggable: draggable,

    // 1-1_2_4:完成画像の表示
    bannercard: {
     props: ['bannerstyle'],
     template: `
      <v-card title="ユーザーネーム" height="120" block :style="bannerstyle">
       <v-container>
        <p class="text-h6">こんにちは！</p>
       </v-container>
      </v-card>
      <br>
     `},

    // BASIC/USER:タイトル+空のデータ追加ボタン
    d_titlebar: {
     props: ['title'],
     emits: ['addbtn'],
     template: `
    <v-toolbar density="compact">
      <v-toolbar-title class="text-h5">{{ title }}</v-toolbar-title>
      <v-spacer></v-spacer>
      <v-btn variant="elevated" color="primary" @click="$emit('addbtn')">
        <v-icon>mdi-plus</v-icon> 新規作成
        <v-tooltip activator="parent" location="bottom">{{ title }} に空のデータを追加します</v-tooltip>
      </v-btn>
    </v-toolbar>
    <br>
  `,
    },


    // 1-1_1-3:TEXTCOLORコンポーネント
    d_textcolor: {
     props: ['target', 'colors'],
     template: `
<v-col cols="12" sm="6" md="3">
  <v-menu>
    <template v-slot:activator="{ props }">
      <v-btn v-bind="props" block>▼ 文字色 : {{ colors[target].name }}</v-btn>
    </template>
    <v-list>
      <v-list-item v-for="(color, key) in colors" :key="key" @click="handleColorClick(key)">
        <v-list-item-title>{{ color.name }}</v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>
</v-col>
  `,
     methods: {
      handleColorClick(key) {
       // 色が選択されたときに親コンポーネントにイベントを発行する
       this.$emit('selected', key);
      }
     }
    },


    // 1-1_1-3:BACKCOLORコンポーネント
    d_backcolor: {
     props: ['target', 'colors', 'btnstyle', 'liststyle'],
     template: `
<v-col cols="12" sm="6" md="3">
  <v-menu>
    <template v-slot:activator="{ props }">
      <v-btn v-bind="props" block :style="btnstyle">
       ▼ 背景色 : {{ colors[target].name }}
      </v-btn>
    </template>
    <v-list>
      <v-list-item v-for="(color, key) in colors" :key="key" @click="handleColorClick(key)" :style="{ color: liststyle, backgroundColor: color.color }">
        <v-list-item-title>{{ color.name }}</v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>
</v-col>
  `,
     methods: {
      handleColorClick(key) {
       // 色が選択されたときに親コンポーネントにイベントを発行する
       this.$emit('selected', key);
      }
     }
    },


    // 1-1_1-3:GRADATIONコンポーネント
    d_gradation: {
     props: ['target', 'colors', 'btnstyle'],
     template: `
<v-col cols="12" sm="6" md="3">
  <v-menu>
    <template v-slot:activator="{ props }">
      <v-btn v-bind="props" block :style="btnstyle">
       ▼ グラデーション : {{ colors[target].name }}
      </v-btn>
    </template>
    <v-list>
      <v-list-item v-for="(color, key) in colors" :key="key" @click="handleColorClick(key)" :style="{ backgroundImage: colors[key].color, backgroundPosition: 'right', backgroundRepeat: 'no-repeat', backgroundSize: '50%' }">
        <v-list-item-title>{{ color.name }}</v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>
</v-col>
  `,
     methods: {
      handleColorClick(key) {
       // 色が選択されたときに親コンポーネントにイベントを発行する
       this.$emit('selected', key);
      }
     }
    },


    // 1-1_1-3:IMAGESコンポーネント
    d_images: {
     props: ['target', 'colors', 'btnstyle'],
     template: `
<v-col cols="12" sm="6" md="3">
  <v-menu>
    <template v-slot:activator="{ props }">
      <v-btn v-bind="props" block :style="btnstyle">
       ▼ キャラクター : {{ colors[target].name }}
      </v-btn>
    </template>
    <v-list>
      <v-list-item v-for="(color, key) in colors" :key="key" @click="handleColorClick(key)" :style="{ backgroundImage: 'url(' + colors[key].color + ')', backgroundPosition: 'right', backgroundSize: 'contain', backgroundRepeat: 'no-repeat' }">
        <v-list-item-title>{{ color.name }}</v-list-item-title>
      </v-list-item>
    </v-list>
  </v-menu>
</v-col>
  `,
     methods: {
      // 色が選択されたときに親コンポーネントにイベントを発行する
      handleColorClick(key) {
       this.$emit('selected', key);
      }
     }
    },


    // 2-1_2-4:リストのtoolbarコンポーネント
    d_list_toolbar: {
     props: ['element',],
     emits: ['clearbtn'],
     template: `
          <v-toolbar density="compact" color="transparent">
           <v-toolbar-title>
            <div class="text-h5">{{element.name}}</div>
           </v-toolbar-title>
           <template v-slot:append>
            <v-btn height="30" width="30" icon @click.stop="$emit('clearbtn')">
             <v-icon>mdi-close</v-icon>
             <v-tooltip activator="parent" location="bottom">この設定を消去</v-tooltip>
            </v-btn>
           </template>
          </v-toolbar>
     `,
    },


    // 1-1_2-4:ダイアログコンポーネント
    d_dialog_name: {
     props: ['dialogOpen', 'value'],
     data() {
      return {
       editedName: this.value.name,
       dialogOpen: false,
      };
     },
     template: `
<v-btn icon variant="text" @click="dialogOpen = true">
 <v-icon>mdi-pencil</v-icon>
 <v-tooltip activator="parent" location="bottom">名前を変更する</v-tooltip>
</v-btn>

<v-dialog v-model="dialogOpen" max-width="400">
  <v-card>
    <v-card-title>名前を編集する</v-card-title>
    <v-card-text>
      <v-text-field v-model="editedName" label="新しい名前"></v-text-field>
    </v-card-text>
    <v-card-actions>
      <v-row>
        <v-col cols="6">
          <v-btn variant="elevated" block color="primary" @click="submitName">送信</v-btn>
        </v-col>
        <v-col>
          <v-btn block @click="closeDialog">キャンセル</v-btn>
        </v-col>
      </v-row>
    </v-card-actions>
  </v-card>
</v-dialog>
  `,
     methods: {
      submitName() {
       this.$emit('submit', this.editedName);
       this.closeDialog();
      },
      closeDialog() {
       this.dialogOpen = false;
      }
     }
    },
   },

   created() {
    // electronが動いていないなら、デバッグモード
    if (!window.electron) {
     this.presetDATAOBJ(ELDERTEMPLATE)
    } else {
     // 読み込んだ__user__.json、またはプリセットデータを入れる
     window.electron.getDATAOBJ().then(electrondata => {
      if (Object.keys(electrondata).length !== 0) {
       this.DATAOBJ = this.Object2Array(electrondata);
       // text/back/gradation/img をtmpとして配列に変換
       this.STYLE2tmp();
      } else {
       // {}空ならプリセットデータを読む
       this.presetDATAOBJ(ELDERTEMPLATE)
      }
     });
    }
   },

   methods: {
    // プリセットデータから読み込む　     
    presetDATAOBJ(Obj) {
     this.DATAOBJ = this.Object2Array(JSON.parse(JSON.stringify(Obj)));
     // text/back/gradation/img をtmpとして配列に変換
     this.STYLE2tmp();
    },

    // 設定をリセットする
    ResetDATAOBJ() {
     Swal.fire({
      title: `設定をリセットする`,
      text: "設定をリセットし、初期設定に戻します",
      icon: "warning",
      // 1番目ボタン
      confirmButtonText: "リセットする",
      confirmButtonColor: "",
      // 2番目ボタン
      showDenyButton: true,
      denyButtonText: "やめる",
      denyButtonColor: "",
     }).then((result) => {
      if (result.isConfirmed) {
       Swal.fire({
        title: `設定をリセットする`,
        text: "本当によろしいですか？元には戻せませんよ。",
        icon: "warning",
        // 1番目ボタン
        confirmButtonText: "リセットする",
        confirmButtonColor: "",
        // 2番目ボタン
        showDenyButton: true,
        denyButtonText: "やっぱりやめる",
        denyButtonColor: "",
       }).then((result2) => {
        // デコレーション：   
        if (result2.isConfirmed) {
         // ELDERTEMPLATE をプリセットデータに入れる
         this.presetDATAOBJ(ELDERTEMPLATE)
         // リセットしたことを報告
         Swal.fire({
          title: `リセット!`,
          text: "設定をリセットしたよ",
          icon: "success",
         }).then((result3) => {
          window.location.reload();
         });
        }
       });
      }
     });
    },

    // BASIC_IMAGES/USER_IMAGES がObjectなら配列にする
    Object2Array(data) {
     const images = ["BASIC_IMAGES", "USER_IMAGES"];
     for (const image of images) {
      const isArray = Array.isArray(data[image]);
      if (!isArray) {
       // Object を配列に変換
       const arr = Object.values(data[image]);
       data[image] = arr;
      }
     }
     return data
    },

    // BASIC_IMAGES/USER_IMAGES がObjectなら配列にする
    Array2Object(data) {
     const images = ["BASIC_IMAGES", "USER_IMAGES"];
     for (const image of images) {
      const isObject = typeof data[image] === 'object' && !Array.isArray(data[image]);
      if (isObject) {
       // 配列を Object に変換
       const obj = data[image].reduce((acc, value, index) => {
        acc[index] = value;
        return acc;
       }, {});
       data[image] = obj;
      }
     }
     return data;
    },
/*
    // text/back/gradation:tmpとして配列データを作成
    STYLE2tmp() {
     const objectToArray = obj => Object.keys(obj).map(key => ({ ...obj[key], key }));
     this.tmp.TEXTCOLOR = objectToArray(this.DATAOBJ.TEXTCOLOR);
     this.tmp.BACKCOLOR = objectToArray(this.DATAOBJ.BACKCOLOR);
     this.tmp.GRADATION = objectToArray(this.DATAOBJ.GRADATION);
     this.tmp.IMAGES = objectToArray(this.DATAOBJ.IMAGES);
    },
*/
     STYLE2tmp() {
       const objectToArray = obj => {
         const result = [];
         for (const key in obj) {
           if (obj.hasOwnProperty(key)) {
             result.push({ ...obj[key], key });
           }
         }
         return result;
       };

       this.tmp.TEXTCOLOR = objectToArray(this.DATAOBJ.TEXTCOLOR);
       this.tmp.BACKCOLOR = objectToArray(this.DATAOBJ.BACKCOLOR);
       this.tmp.GRADATION = objectToArray(this.DATAOBJ.GRADATION);
       this.tmp.IMAGES = objectToArray(this.DATAOBJ.IMAGES);
     },


    // text/back/gradation:tmpの配列をObjectに戻してDATAOBJに入れる
    tmp2STYLE(style) {
     const resultObject = {};
     const array = this.tmp[style];
     for (const item of array) {
      const key = item.key;
      resultObject[key] = item;
     }
     // 結果をDATAOBJに代入
     this.DATAOBJ[style] = resultObject;
    },

    // jsonファイルを読み込み、設定を変更するかカラーデータを入れ替える
    jsonOpenChange(event) {
     // ファイル未記入ならreturn
     const selectedFile = event.target.files[0];
     if (!selectedFile) return;
     // ファイルをどちらで読み込ませるかを聞く
     let mode;
     Swal.fire({
      title: `${selectedFile.name} を読み込む`,
      icon: "info",
      // 1番目ボタン
      confirmButtonText: "#decoの変更",
      confirmButtonColor: "#3F51B5",
      // 2番目ボタン
      showDenyButton: true,
      denyButtonColor: "#009688",
      denyButtonText: "カラーテンプレートの変更",
      // 3番目ボタン
      showCancelButton: true,
      cancelButtonColor: "",
      cancelButtonText: "キャンセル",
     }).then((result) => {
      // デコレーション：
      if (result.isConfirmed) {
       mode = 1;
      } else if (result.isDenied) {
       mode = 2;
      } else {
       return;
      }
      // ファイルの内容をメインに読んでもらう
      window.electron.jsonfile_readme(selectedFile)
       .then((jsondata) => {
        // データの整合性チェック
        const parsedData = JSON.parse(jsondata);
        const requiredKeys = ['preferences', 'BASIC_IMAGES', 'ROLE_IMAGES', 'USER_IMAGES', 'TEXTCOLOR', 'BACKCOLOR', 'GRADATION', 'IMAGES'];
        const missingKeys = requiredKeys.filter(key => {
         const value = parsedData[key];
         return !Array.isArray(value) && typeof value !== 'object';
        });
        if (missingKeys.length !== 0) {
         Swal.fire("ファイルが読み込めませんでした。", "ファイルが破損してます", "error");
         return;
        }
        // デコレーション(DATAOBJ)を変更
        if (mode === 1) {
         Swal.fire({
          title: `${selectedFile.name} を適用する`,
          text: "編集中のデータは消えてしまいますがよろしいですか？",
          icon: "warning",
          // 1番目ボタン
          confirmButtonText: "デコレーション!",
          confirmButtonColor: "",
          // 2番目ボタン
          showDenyButton: true,
          denyButtonText: "やめる",
          denyButtonColor: "",
          // 3番目ボタン
          showCancelButton: true,
          cancelButtonText: "キャンセル",
          cancelButtonColor: "",
         }).then((result) => {
          // デコレーション：   
          if (result.isConfirmed) {
           // DATAOBJにセット
           this.presetDATAOBJ(parsedData)
           window.location.reload();
          }
         });
         // パレットを変更
        } else if (mode === 2) {
         Swal.fire({
          title: `${selectedFile.name} を適用する`,
          text: "パレットのテンプレート（＋追加ボタンの内容）を変更します。よろしいですか?",
          icon: "warning",
          // 1番目ボタン
          confirmButtonText: "テンプレート変更!",
          confirmButtonColor: "",
          // 2番目ボタン
          showDenyButton: true,
          denyButtonColor: "",
          denyButtonText: "やめる",
          // 3番目ボタン
          showCancelButton: true,
          cancelButtonColor: "",
          cancelButtonText: "キャンセル",
         }).then((result) => {
          // デコレーション：   
          if (result.isConfirmed) {
           // TEMPLATEOBJにセット
           this.TEMPLATEOBJ = this.Object2Array(JSON.parse(JSON.stringify(parsedData)));
           // 変更完了
           Swal.fire({
            title: "変更完了!",
            text: "新しいパレットが使えるようになったよ。＋追加から追加してね。",
            icon: "success"
           });
          }
         });

        }

       })
       .catch((err) => {
        console.error(err);
        Swal.fire("ファイルが読み込めませんでした。", "読み込みエラー", "error");
        return;
       });
     });


    },


    //// ファイル更新
    // tmpを更新、JSONを書き足す
    tmp_updata() {
     const styles = ["TEXTCOLOR", "BACKCOLOR", "GRADATION", "IMAGES"];
     styles.forEach(style => {
      this.tmp2STYLE(style);
     });
    },

    //// テンプレートファイル書き出し  
    async outputTemplate() {
     // テンプレート未選択ならreturn
     if (this.OnecomeSelect.includes("テンプレート")) {
      Swal.fire({
       icon: "error",
       title: "テンプレートが選択されてないよ",
       text: "テンプレートを選択してください",
      });
      return;
     } else if (this.OnecomeSelect.includes("jsonのみ")) {
      // json出力ならダイアログを出して保存させる
      const jsonDataString = JSON.stringify(this.DATAOBJ);
      const blob = new Blob([jsonDataString], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'decoration.json';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
     } else {
      // わんコメテンプレートを出力する
      const temp = this.OnecomeSelect
      Swal.fire({
       title: `テンプレートを出力する`,
       text: `「${temp}」テンプレートを出力しますか？`,
       icon: "info",
       // 1番目ボタン
       confirmButtonText: "出力する!",
       confirmButtonColor: "",
       // 2番目ボタン
       showDenyButton: true,
       denyButtonText: "キャンセル",
       denyButtonColor: "",
      }).then((result) => {
       // デコレーション：   
       if (result.isConfirmed) {
        try {
         window.electron.makeTemplate(temp);
        } catch (error) {
         console.error('Error making template:', error);
        }
       }
      });
     }
    },

    //// ファイル呼び出し
    // BASIC/ROLE/USER:対象のObjectを取得
    getIMAGES(mode, type = "tmp") {
     switch (mode) {
      case 'BASIC_IMAGES':
       return this.DATAOBJ.BASIC_IMAGES;
      case 'ROLE_IMAGES':
       return this.DATAOBJ.ROLE_IMAGES;
      case 'USER_IMAGES':
       return this.DATAOBJ.USER_IMAGES;
      case 'TEXTCOLOR':
       return this[type === 'data' ? 'DATAOBJ' : 'tmp'].TEXTCOLOR;
      case 'BACKCOLOR':
       return this[type === 'data' ? 'DATAOBJ' : 'tmp'].BACKCOLOR;
      case 'GRADATION':
       return this[type === 'data' ? 'DATAOBJ' : 'tmp'].GRADATION;
      case 'IMAGES':
       return this[type === 'data' ? 'DATAOBJ' : 'tmp'].IMAGES;
      default:
       throw new Error(`Invalid mode: ${mode}`);
     }
    },


    //// 設定画面表示
    // 設定に合わせたデコレーションの付与
    // 0:非表示
    // 1:グラデーション
    // 2:キャラ
    // 3:グラデーション+キャラ
    // 4:単色背景
    // 5:単色背景+キャラ 
    getDecorationStyle(key, edit = 0) {
     // DATAOBJがundefined/空ならreturn
     if (!this.DATAOBJ.BASIC_IMAGES || Object.keys(this.DATAOBJ.BASIC_IMAGES).length === 0) return;

     // keyが存在しない場合、BASIC/ROLE/USERにあるkeyをnoneに変換する
     this.check2None.call(this, key.text, 'TEXTCOLOR', 'text');
     this.check2None.call(this, key.back, 'BACKCOLOR', 'back');
     this.check2None.call(this, key.gradation, 'GRADATION', 'gradation');
     this.check2None.call(this, key.img, 'IMAGES', 'img');

     let mode = edit ? edit : 3;
     // x_objに当てはめる
     const t_obj = this.DATAOBJ.TEXTCOLOR[key.text];
     const b_obj = this.DATAOBJ.BACKCOLOR[key.back];
     const g_obj = this.DATAOBJ.GRADATION[key.gradation];
     const i_obj = this.DATAOBJ.IMAGES[key.img];


     let text = t_obj.color;
     let back = b_obj.color;
     let gradation = g_obj.color;
     const imgcheck = i_obj.color;
     let img = imgcheck.length !== 0 ? `url('${imgcheck}')` : "";

     if (mode === 0) {
      return;
     }
     // グラデーションのみOFF
     if (mode === 4 || mode === 5) {
      gradation = "";
     }
     // キャラOFF
     if (mode === 1 || mode === 4) {
      img = "";
     }
     // テキスト色・背景色・グラデーションOFF
     if (mode === 2) {
      text = "";
      back = "";
      gradation = "";
     }

     // imgのオプション
     const dot = gradation && img ? "," : "";

     const g_positionX = gradation.length !== 0 ? 100 + '%' : "";
     const g_positionY = gradation.length !== 0 ? 100 + '%' : "";
     const g_sizeX = gradation.length !== 0 ? 'auto' : "";
     const g_sizeY = gradation.length !== 0 ? 'auto' : "";
     const g_repeat = gradation.length !== 0 ? 'no-repeat' : "";

     const i_positionX = img.length !== 0 ? i_obj.positionX + '%' : "";
     const i_positionY = img.length !== 0 ? i_obj.positionY + '%' : "";
     const i_sizeX = img.length !== 0 ? i_obj.sizeXauto ? 'auto' : i_obj.sizeX + '%' : "";
     const i_sizeY = img.length !== 0 ? i_obj.sizeYauto ? 'auto' : i_obj.sizeY + '%' : "";
     const i_repeat = img.length !== 0 ? i_obj.repeat : "";


     return {
      color: text,
      backgroundColor: back,
      backgroundImage: img + dot + gradation,
      "background-position-x": i_positionX + dot + g_positionX,
      "background-position-y": i_positionY + dot + g_positionY,
      backgroundSize: `${i_sizeX} ${i_sizeY} ${dot} ${g_sizeX} ${g_sizeY}`,
      backgroundRepeat: i_repeat + dot + g_repeat,
     }
    },

    // keyが存在するかチェックし、なければnoneに変更する
    check2None(key, LEVEL, mode) {
     if (!this.DATAOBJ[LEVEL][key]) {
      // BASIC_IMAGES / USER_IMAGES(Array)
      const imageKeys = ['BASIC_IMAGES', 'USER_IMAGES'];
      imageKeys.forEach(keyName => {
       this.DATAOBJ[keyName].forEach(item => {
        if (item[mode] === key) item[mode] = 'none';
       });
      });
      // ROLE_IMAGES(Obj)
      const imageKeysobj = ['ROLE_IMAGES',];
      imageKeysobj.forEach(keyName => {
       Object.values(this.DATAOBJ[keyName]).forEach(item => {
        if (item[mode] === key) item[mode] = 'none';
       });
      });
     }
    },

    // GRADATION IMAGES の背景スタイル
    getBackgroundStyle(Obj, mode) {
     const sizeX = Obj.sizeXauto ? 'auto' : Obj.sizeX + '%';
     const sizeY = Obj.sizeYauto ? 'auto' : Obj.sizeY + '%';
     return {
      backgroundImage: mode === 'GRADATION' ? Obj.color : `url(${Obj.color})`,
      "background-position-x": Obj.positionX + '%',
      "background-position-y": Obj.positionY + '%',
      backgroundSize: `${sizeX} ${sizeY}`,
      backgroundRepeat: Obj.repeat,
     };
    },

    // electronから相対パスを取得
    getRelative(event, mode, index) {
     const targetImages = this.getIMAGES(mode);
     const absPath = event.target.files[0].path; // ファイルの絶対パスを取得
     // メインプロセスで相対パスを取得
     window.electron.getRelative(absPath)
      .then((relative) => {
       targetImages[index].color = relative.replace(/\\/g, '/'); // ファイルの相対パスを設定
      })
      .catch((err) => {
       console.error(err);
      });
    },

    // TEXT/BACK/GRADATION/IMAGES:Objectをテンプレートから選択して追加
    SelectNewImage(mode, value, key) {
     Swal.fire({
      title: `「${value.name}」を追加する`,
      text: `テンプレート「${value.name}」を追加します。`,
      icon: "info",
      // 1番目ボタン
      confirmButtonText: "OK!",
      confirmButtonColor: "",
      // 2番目ボタン
      showDenyButton: true,
      denyButtonText: "やめる",
      denyButtonColor: "",
     }).then((result) => {
      // デコレーション：   
      if (result.isConfirmed) {
       const template = JSON.parse(JSON.stringify(this.TEMPLATEOBJ[mode][key]));
       if (!template) {
        console.error(`テンプレートが見つかりません: mode = ${mode}, key = ${key}`);
       }
       // keyがある(素材である)なら、ユニークなキーを生成
       const searchObj = this.getIMAGES(mode, 'data');
       let newKey = key;
       let index = 1;
       while (searchObj[newKey]) {
        newKey = `user${index}`;
        index++;
       }
       template.key = newKey;
       // テンプレートを追加
       const sourceArray = this.getIMAGES(mode);
       sourceArray.splice(1, 0, template);
       this.tmp_updata(); // tmp->DATAOBJへ更新
       this.snackbar.new = true; // snackbarを表示
      }
     });
    },

    // BASIC/USER:空のデータを追加
    NullAddImage(mode) {
     let template;
     if (mode === "BASIC_IMAGES") {
      template = {
       ran: 1,
       img: "none",
       text: "none",
       back: "none",
       gradation: "none",
      };
     } else {
      template = {
       username: ["ユーザー"],
       img: "none",
       text: "none",
       back: "none",
       gradation: "none",
      };

     }
     // テンプレートを追加
     const sourceArray = this.getIMAGES(mode);
     sourceArray.unshift(template)
     this.snackbar.new = true; // snackbarを表示
    },

    // BASIC/USER/TEXT/BACK/GRADATION/IMAGES:Objectからプロパティを削除
    clearImageArr(mode, value, index) {
     Swal.fire({
      title: `${value.name ? value.name : "#" + (index + 1)} を消去する`,
      text: "この設定を消去しますか？",
      icon: "warning",
      // 1番目ボタン
      confirmButtonText: "OK",
      confirmButtonColor: "",
      // 2番目ボタン
      showDenyButton: true,
      denyButtonColor: "",
      denyButtonText: "キャンセル",
     }).then((result) => {
      if (result.isConfirmed) {
       const sourceArray = this.getIMAGES(mode);
       sourceArray.splice(index, 1);
       this.tmp_updata(); // tmp->DATAOBJへ更新
       this.snackbar.clear = true; // snackbarを表示
      }
     });
    },


    //// コンポーネント関係
    // 子コンポーネント:テキスト色/背景色/を変更
    handleCOLOR(mode, index, type, event) {
     this.DATAOBJ[mode][index][type] = event;
    },

    // ran の数値を合計したものと、引数に対しての％を返す(basicのみ)
    sumRanValues(num) {
     const total = this.DATAOBJ.BASIC_IMAGES.reduce((sum, obj) => sum + (obj.hasOwnProperty('ran') ? parseInt(obj.ran) : 0), 0);
     return Math.round((num / total) * 100);
    },
   },

   watch: {
    // DATAOBJが変更されたらelectron側に伝えて
    DATAOBJ: {
     deep: true,
     handler(newValue, oldValue) {
      if (window.electron) {
       window.electron.objsaveflag(true, JSON.stringify(this.DATAOBJ));
      }
     },
    },
   },
  });
  app.use(vuetify).mount('#app');
 </script>
</body>

</html>